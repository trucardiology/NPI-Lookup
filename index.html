<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search NPI Database</title>  
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div id="search-container" class="card">
            <h1 class="heading-primary">Search NPI Database</h1>
            
            <!-- Search form -->
            <form id="search-form">
                <div class="input-group">
                    <div>
                        <label for="npi" class="form-label">NPI Number</label>
                        <input type="text" id="npi" name="npi" class="form-input">
                    </div>
                     <div class="relative">
                        <label for="taxonomy-input" class="form-label">Taxonomy Description</label>
                        <input type="text" id="taxonomy-input" class="form-input" autocomplete="off">
                        <div id="taxonomy-dropdown" class="taxonomy-dropdown hidden">
                            <!-- Options will be populated by JS -->
                        </div>
                    </div>
                    <div>
                        <label for="first_name" class="form-label">First Name</label>
                        <input type="text" id="first_name" name="first_name" class="form-input">
                    </div>
                    <div>
                        <label for="last_name" class="form-label">Last Name</label>
                        <input type="text" id="last_name" name="last_name" class="form-input">
                    </div>
                     <div>
                        <label for="organization_name" class="form-label">Organization Name</label>
                        <input type="text" id="organization_name" name="organization_name" class="form-input">
                    </div>
                    <div>
                        <label for="city" class="form-label">City</label>
                        <input type="text" id="city" name="city" class="form-input">
                    </div>
                    <div>
                        <label for="state" class="form-label">State (2-letter code)</label>
                        <input type="text" id="state" name="state" maxlength="2" class="form-input">
                    </div>
                </div>
                <div class="mt-8">
                    <button type="submit" id="search-btn" class="search-btn">
                        Search
                    </button>
                </div>
            </form>
        </div>

        <!-- Container for results and details -->
        <div id="results-container" class="mt-8"></div>
        <div id="detail-container" class="mt-8 hidden"></div>
    </div>

    <script>
        const searchForm = document.getElementById('search-form');
        const searchContainer = document.getElementById('search-container');
        const resultsContainer = document.getElementById('results-container');
        const detailContainer = document.getElementById('detail-container');

        let currentResultsData = [];

        // --- Taxonomy Dropdown Logic ---
        const taxonomyInput = document.getElementById('taxonomy-input');
        const taxonomyDropdown = document.getElementById('taxonomy-dropdown');
        const taxonomyList = [
            "Acupuncturist", "Allergy & Immunology", "Anesthesiology", "Audiologist", "Cardiology",
            "Chiropractic", "Clinical Cardiac Electrophysiology", "Clinical Neuropsychologist", "Clinical Psychologist", "Clinical Social Worker",
            "Colon & Rectal Surgery", "Counselor", "Critical Care Medicine", "Dentist", "Dermatology",
            "Diagnostic Radiology", "Dietitian, Registered", "Durable Medical Equipment & Medical Supplies", "Emergency Medicine", "Endocrinology, Diabetes & Metabolism",
            "Family Medicine", "Gastroenterology", "General Practice", "General Surgery", "Genetics, Medical",
            "Geriatric Medicine", "Hematology", "Hematology & Oncology", "Home Health", "Hospice",
            "Hospitalist", "Infectious Disease", "Internal Medicine", "Interventional Cardiology", "Interventional Radiology",
            "Licensed Practical Nurse", "Marriage & Family Therapist", "Massage Therapist", "Medical Oncology", "Mental Health Counselor",
            "Midwife", "Nephrology", "Neurology", "Neurosurgery", "Nurse Practitioner",
            "Obstetrics & Gynecology", "Occupational Therapist", "Oncology", "Ophthalmology", "Optometrist",
            "Oral & Maxillofacial Surgery", "Orthopaedic Surgery", "Otolaryngology", "Pain Medicine", "Pathology",
            "Pediatrics", "Pharmacy", "Physical Medicine & Rehabilitation", "Physical Therapist", "Physician Assistant",
            "Plastic Surgery", "Podiatry", "Psychiatry", "Psychiatry & Neurology", "Psychologist",
            "Pulmonary Disease", "Radiation Oncology", "Radiology", "Registered Nurse", "Rheumatology",
            "Skilled Nursing Facility", "Sleep Medicine", "Social Worker", "Speech-Language Pathologist", "Sports Medicine",
            "Surgery", "Thoracic Surgery (Cardiothoracic Vascular Surgery)", "Urology", "Vascular Surgery"
        ];

        function populateTaxonomyDropdown() {
            taxonomyDropdown.innerHTML = '';
            taxonomyList.forEach(item => {
                const option = document.createElement('div');
                option.classList.add('taxonomy-option');
                option.textContent = item;
                option.addEventListener('mousedown', () => { // mousedown fires before blur
                    taxonomyInput.value = item;
                    taxonomyDropdown.classList.add('hidden');
                });
                taxonomyDropdown.appendChild(option);
            });
        }

        function filterTaxonomyDropdown() {
            const filter = taxonomyInput.value.toUpperCase();
            const options = taxonomyDropdown.getElementsByClassName('taxonomy-option');
            for (let i = 0; i < options.length; i++) {
                const txtValue = options[i].textContent || options[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    options[i].style.display = "";
                } else {
                    options[i].style.display = "none";
                }
            }
        }

        taxonomyInput.addEventListener('focus', () => taxonomyDropdown.classList.remove('hidden'));
        taxonomyInput.addEventListener('blur', () => {
            // We use a short delay to allow the click on an option to register
            setTimeout(() => taxonomyDropdown.classList.add('hidden'), 150);
        });
        taxonomyInput.addEventListener('input', filterTaxonomyDropdown);

        // Initial population
        populateTaxonomyDropdown();
        // --- End Taxonomy Dropdown Logic ---


        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            detailContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            resultsContainer.innerHTML = `<div class="card p-8 rounded-xl shadow-lg text-center"><p class="text-secondary">Searching for providers...</p></div>`;

            const params = new URLSearchParams({ version: '2.1' });

            const npi = document.getElementById('npi').value;
            const firstName = document.getElementById('first_name').value;
            const lastName = document.getElementById('last_name').value;
            const organizationName = document.getElementById('organization_name').value;
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;
            const taxonomy = document.getElementById('taxonomy-input').value; // Updated to use new input

            if (npi) params.append('number', npi);
            if (firstName) params.append('first_name', firstName);
            if (lastName) params.append('last_name', lastName);
            if (organizationName) params.append('organization_name', organizationName);
            if (city) params.append('city', city);
            if (state) params.append('state', state);
            if (taxonomy) params.append('taxonomy_description', taxonomy);

            const queryString = params.toString();
            if (queryString === 'version=2.1') {
                 resultsContainer.innerHTML = `<div class="card p-8 rounded-xl shadow-lg text-center"><h3 class="heading-primary text-lg font-medium text-gray-800">Please enter search criteria</h3><p class="text-secondary mt-1">You must provide at least one search term to get results.</p></div>`;
                return;
            }

            const apiUrl = `https://npiregistry.cms.hhs.gov/api/?${queryString}`;
            const url = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (!response.ok || data.Errors) {
                     const error = data.Errors ? data.Errors[0].description : `API error: ${response.statusText} (Status: ${response.status})`;
                     throw new Error(error);
                }
                displayResults(data);
            } catch (error) {
                console.error("Failed to fetch NPI data:", error);
                resultsContainer.innerHTML = `<div class="card p-8 rounded-xl shadow-lg text-center"><h3 class="heading-primary text-lg font-medium text-red-700">An Error Occurred</h3><p class="text-secondary mt-1">${error.message}. Please try again.</p></div>`;
            }
        });

        function displayResults(data) {
            currentResultsData = data.results || [];
            if (data.result_count === 0) {
                resultsContainer.innerHTML = `<div class="card p-8 rounded-xl shadow-lg text-center"><h3 class="heading-primary text-lg font-medium text-gray-800">No Results Found</h3><p class="text-secondary mt-1">Please try again with different search criteria.</p></div>`;
                return;
            }

            let tableRows = '';
            currentResultsData.forEach((provider, index) => {
                const basic = provider.basic || {};
                const name = basic.organization_name || `${basic.first_name || ''} ${basic.last_name || ''}`.trim();
                const primaryTaxonomy = provider.taxonomies.find(t => t.primary) || provider.taxonomies[0] || { desc: 'N/A' };
                const location = provider.addresses.find(a => a.address_purpose === 'LOCATION') || provider.addresses[0] || {};
                const address = location.address_1 ? `${location.address_1}, ${location.city}, ${location.state} ${location.postal_code}` : 'N/A';

                tableRows += `
                    <tr>
                        <td><a href="#" onclick="showProviderDetails(${index}); return false;" class="link-text">${provider.number}</a></td>
                        <td>${name}</td>
                        <td>${primaryTaxonomy.desc}</td>
                        <td>${address}</td>
                    </tr>`;
            });

            resultsContainer.innerHTML = `
                <div class="results-table-wrapper">
                    <div class="table-header"><h2>Search Results</h2><p>Found ${data.result_count} matching provider(s).</p></div>
                    <table><thead><tr><th>NPI</th><th>Name</th><th>Primary Taxonomy</th><th>Location</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;
        }

        function showProviderDetails(index) {
            const provider = currentResultsData[index];
            resultsContainer.classList.add('hidden');
            detailContainer.classList.remove('hidden');

            const basic = provider.basic || {};
            const name = basic.organization_name || `${basic.first_name || ''} ${basic.last_name || ''}`.trim();
            const status = basic.status === 'A' ?
                '<span class="text-xs font-semibold bg-green-100 text-green-800 px-2 py-1 rounded-full">Active</span>' :
                '<span class="text-xs font-semibold bg-red-100 text-red-800 px-2 py-1 rounded-full">Inactive</span>';

            // Format addresses with correct labels
            let addressesHtml = provider.addresses.map(addr => {
                let purpose = addr.address_purpose;
                if(purpose === 'LOCATION') purpose = 'Primary Practice Address';
                if(purpose === 'MAILING') purpose = 'Mailing Address';
                return `
                    <div class="border-t border-gray-200 pt-4 mt-4 first:mt-0 first:pt-0 first:border-0">
                        <h4 class="font-semibold text-gray-700">${purpose}</h4>
                        <p class="text-gray-600">${addr.address_1}${addr.address_2 ? ', ' + addr.address_2 : ''}</p>
                        <p class="text-gray-600">${addr.city}, ${addr.state} ${addr.postal_code}</p>
                        <p class="text-gray-600 mt-1">Phone: ${addr.telephone_number || 'N/A'}</p>
                        <p class="text-gray-600">Fax: ${addr.fax_number || 'N/A'}</p>
                    </div>`
                }).join('');
            if (provider.addresses.length === 0) addressesHtml = '<p class="text-gray-500">No addresses listed.</p>';

            // Format taxonomies
            let taxonomiesHtml = provider.taxonomies.map(tax => `
                <li class="py-3 flex justify-between items-start">
                    <div>
                        <p class="font-medium text-gray-800">${tax.desc}</p>
                        <p class="text-sm text-gray-500">Code: ${tax.code} | License: ${tax.license || 'N/A'} (${tax.state || 'N/A'})</p>
                    </div>
                    ${tax.primary ? '<span class="text-xs font-semibold bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full ml-4 flex-shrink-0">Primary</span>' : ''}
                </li>
            `).join('');

            // Format other identifiers
            let identifiersHtml = provider.identifiers.map(id => `
                <li class="py-3">
                    <p class="font-medium text-gray-800">${id.desc}</p>
                    <p class="text-sm text-gray-500">ID: ${id.identifier} ${id.state ? `(${id.state})` : ''} ${id.issuer ? ` | Issuer: ${id.issuer}` : ''}</p>
                </li>
            `).join('');
            if (provider.identifiers.length === 0) identifiersHtml = '<li class="text-gray-500 py-2">No other identifiers listed.</li>';

             // Format Endpoints
            let endpointsHtml = (provider.endpoints || []).map(ep => `
                <li class="py-3">
                    <p class="font-medium text-gray-800">${ep.endpointTypeDescription}</p>
                    <p class="text-sm text-gray-500 break-all">Endpoint: ${ep.endpoint}</p>
                     <p class="text-sm text-gray-500">Affiliation: ${ep.affiliation || 'N/A'}</p>
                </li>
            `).join('');
            if (!provider.endpoints || provider.endpoints.length === 0) endpointsHtml = '<li class="text-gray-500 py-2">No Health Information Exchange endpoints listed.</li>';


            // Format Authorized Official
            let authorizedOfficialHtml = 'Not available';
            if(basic.authorized_official_first_name) {
                authorizedOfficialHtml = `
                    <p class="font-medium text-gray-800">${basic.authorized_official_first_name} ${basic.authorized_official_last_name}</p>
                    <p class="text-sm text-gray-500">${basic.authorized_official_title_or_position || 'N/A'}</p>
                    <p class="text-sm text-gray-500">Phone: ${basic.authorized_official_telephone_number || 'N/A'}</p>
                `;
            }

            detailContainer.innerHTML = `
                <div class="card p-6 sm:p-8">
                    <!-- Header -->
                    <div class="flex justify-between items-start pb-4 border-b border-gray-200">
                        <div>
                            <h2 class="heading-primary">${name}</h2>
                            <p class="text-lg text-gray-600">NPI: ${provider.number}</p>
                        </div>
                        <button onclick="backToResults()" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 inline-flex items-center flex-shrink-0 ml-4">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
                            Back to Results
                        </button>
                    </div>

                    <!-- Details Grid -->
                    <div class="mt-6 space-y-6">

                        <!-- General Information Card -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                             <h3 class="text-lg font-semibold text-gray-800 mb-3">General Information</h3>
                             <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm">
                                <div><p class="font-medium text-gray-500">Status</p><p class="text-gray-800">${status}</p></div>
                                <div><p class="font-medium text-gray-500">Enumeration Date</p><p class="text-gray-800">${basic.enumeration_date || 'N/A'}</p></div>
                                <div><p class="font-medium text-gray-500">Last Updated</p><p class="text-gray-800">${basic.last_updated || 'N/A'}</p></div>
                                <div><p class="font-medium text-gray-500">NPI Type</p><p class="text-gray-800">${provider.enumeration_type === 'NPI-1' ? 'Individual' : 'Organization'}</p></div>
                                <div><p class="font-medium text-gray-500">Sole Proprietor</p><p class="text-gray-800">${basic.sole_proprietor || 'N/A'}</p></div>
                                ${provider.enumeration_type === 'NPI-1' ? `<div><p class="font-medium text-gray-500">Gender</p><p class="text-gray-800">${basic.gender || 'N/A'}</p></div>` : ''}
                             </div>
                        </div>

                        <!-- Authorized Official Card -->
                        ${provider.enumeration_type === 'NPI-2' ? `
                        <div class="bg-gray-50 p-4 rounded-lg">
                             <h3 class="text-lg font-semibold text-gray-800 mb-3">Authorized Official</h3>
                             <div class="text-sm">${authorizedOfficialHtml}</div>
                        </div>` : ''}

                        <!-- Main Details in Two Columns -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">

                            <!-- Addresses -->
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Addresses</h3>
                                ${addressesHtml}
                            </div>

                            <!-- Taxonomies -->
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Taxonomies</h3>
                                <ul class="divide-y divide-gray-200">${taxonomiesHtml}</ul>
                            </div>

                             <!-- Endpoints -->
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Health Information Exchange</h3>
                                <ul class="divide-y divide-gray-200">${endpointsHtml}</ul>
                            </div>

                            <!-- Other Identifiers -->
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Other Identifiers</h3>
                                <ul class="divide-y divide-gray-200">${identifiersHtml}</ul>
                            </div>

                        </div>
                    </div>
                </div>
            `;
        }

        function backToResults() {
            detailContainer.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            detailContainer.innerHTML = '';
        }

    </script>
</body>
</html>
